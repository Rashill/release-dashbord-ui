<div class="container mb-5">
  <div class="card mx-auto">
    <div class="card-body">
      <div class="card-title text-center mb-5">
        <h2>{{ mode }} Release</h2>
      </div>

      <div class="alert alert-danger" *ngIf="error">
        {{ errorMessage }}
      </div>

      <form novalidate [formGroup]="createForm" (ngSubmit)="onSubmit()">
        <form-wizard [txtBtnDone]="mode">
          <!-- Basic info. -->
          <wizard-step
            [title]="'1: Basic info.'"
            [isValid]="isValidStep('step1')"
          >
            <br />

            <div class="row col-md-12">
              <div class="form-group col-md-6">
                <label for="name">Release Name</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="name"
                    [(ngModel)]="release.name"
                    placeholder="Release Name"
                    [className]="
                      !isValid('name')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('name')"
                  >
                    {{ getValidationMsg('name') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="Type">Release Type</label>
                <div class="input-group">
                  <select
                    class="form-control"
                    id="releaseType"
                    required
                    formControlName="releaseType"
                    [(ngModel)]="release.releaseType"
                    name="releaseType"
                    [className]="
                      !isValid('releaseType')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  >
                    <option value="OOC" selected>OOC</option>
                    <option value="ER">ER</option>
                    <option value="Hot Fix">Hot Fix</option>
                  </select>
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('type')"
                  >
                    {{ getValidationMsg('type') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="Description">Description</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="description"
                    [(ngModel)]="release.description"
                    placeholder="Description"
                    [className]="
                      !isValid('description')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('description')"
                  >
                    {{ getValidationMsg('description') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="releaseDate">Release Date</label>
                <div class="input-group">
                  <input
                    type="date"
                    text="picker"
                    class="form-control"
                    formControlName="releaseDate"
                    [(ngModel)]="release.releaseDate"
                    [className]="
                      !isValid('releaseDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('releaseDate')"
                  >
                    {{ getValidationMsg('releaseDate') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="cabDate">CAB</label>
                <div class="input-group">
                  <input
                    type="date"
                    class="form-control"
                    formControlName="cabDate"
                    [(ngModel)]="release.cabDate"
                    placeholder="CIO2"
                    [className]="
                      !isValid('cabDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('cabDate')"
                  >
                    {{ getValidationMsg('cabDate') }}
                  </div>
                </div>
              </div>
            </div>
          </wizard-step>

          <wizard-step [title]="'2: Dev/Test'" [isValid]="isValidStep('step2')">
            <br />
            <div class="row col-md-12">
              <div class="form-group col-md-6">
                <label for="startDate">Dev/Test Start Date</label>
                <div class="input-group">
                  <div class="input-group">
                    <input
                      type="date"
                      text="picker"
                      class="form-control"
                      formControlName="startDate"
                      [(ngModel)]="release.startDate"
                      [className]="
                        !isValid('startDate')
                          ? 'form-control is-invalid'
                          : 'form-control'
                      "
                    />
                    <!-- validation feedback text -->
                    <div
                      class="form-text invalid-feedback"
                      *ngIf="!isValid('startDate')"
                    >
                      {{ getValidationMsg('startDate') }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="devFinishDate">Dev/Test Finish Date</label>
                <div class="input-group">
                  <input
                    type="date"
                    text="picker"
                    class="form-control"
                    formControlName="devFinishDate"
                    [(ngModel)]="release.devFinishDate"
                    [className]="
                      !isValid('devFinishDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <!-- Commented due to Bug -->
                  <!-- <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('devFinishDate')"
                  >
                    {{ getValidationMsg('devFinishDate') }}
                  </div> -->
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="refreshDate">Potential Code Refresh Date</label>
                <div class="input-group">
                  <input
                    type="date"
                    text="refreshDate"
                    class="form-control"
                    formControlName="refreshDate"
                    [(ngModel)]="release.refreshDate"
                    [className]="
                      !isValid('refreshDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('refreshDate')"
                  >
                    {{ getValidationMsg('refreshDate') }}
                  </div>
                </div>
              </div>
            </div>
          </wizard-step>

          <wizard-step
            [title]="'3: Regression'"
            [isValid]="isValidStep('step3')"
          >
            <br />
            <div class="row col-md-12">
              <div class="form-group col-md-6">
                <label for="regressionDeployDate">Regression Deploy Date</label>
                <div class="input-group">
                  <input
                    type="date"
                    text="regressionDeployDate"
                    class="form-control"
                    formControlName="regressionDeployDate"
                    [(ngModel)]="release.regressionDeployDate"
                    [className]="
                      !isValid('regressionDeployDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('regressionDeployDate')"
                  >
                    {{ getValidationMsg('regressionDeployDate') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="regressionStartDate">Regression Start Date</label>
                <div class="input-group">
                  <input
                    type="date"
                    text="regressionStartDate"
                    class="form-control"
                    formControlName="regressionStartDate"
                    [(ngModel)]="release.regressionStartDate"
                    [className]="
                      !isValid('regressionStartDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('regressionStartDate')"
                  >
                    {{ getValidationMsg('regressionStartDate') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="regressionEndDate">Regression End Date</label>
                <div class="input-group">
                  <input
                    type="date"
                    text="regressionEndDate"
                    class="form-control"
                    formControlName="regressionEndDate"
                    [(ngModel)]="release.regressionEndDate"
                    [className]="
                      !isValid('regressionEndDate')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('regressionEndDate')"
                  >
                    {{ getValidationMsg('regressionEndDate') }}
                  </div>
                </div>
              </div>
            </div>
          </wizard-step>

          <!-- Details -->
          <wizard-step
            [title]="'4: Details'"
            [isValid]="isValidStep('step4')"
            [showNext]="true"
          >
            <br />

            <div class="row col-md-12">
              <div class="form-group col-md-6">
                <label for="testEnvironment">Test Environment</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="testEnvironment"
                    [(ngModel)]="release.testEnvironment"
                    placeholder="CIO2"
                    [className]="
                      !isValid('testEnvironment')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('testEnvironment')"
                  >
                    {{ getValidationMsg('testEnvironment') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="regEnvironment">Regression Environment</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="regEnvironment"
                    [(ngModel)]="release.regEnvironment"
                    placeholder="LAB03"
                    [className]="
                      !isValid('regEnvironment')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('regEnvironment')"
                  >
                    {{ getValidationMsg('regEnvironment') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="sitecore">Site Core</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="sitecore"
                    [(ngModel)]="release.sitecore"
                    placeholder="C5261"
                    [className]="
                      !isValid('sitecore')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('sitecore')"
                  >
                    {{ getValidationMsg('sitecore') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="biztalk">Biz Talk</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="biztalk"
                    [(ngModel)]="release.biztalk"
                    placeholder="C5410"
                    [className]="
                      !isValid('biztalk')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('biztalk')"
                  >
                    {{ getValidationMsg('biztalk') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="devSupport">Dev Support</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="devSupport"
                    [(ngModel)]="displayLabel.devSupport"
                    placeholder="James"
                    (ngModelChange)="displayValueChanged($event, 'devSupport')"
                    [showHint]="false"
                    [ngbTypeahead]="filterAssignee"
                    [inputFormatter]="formatter"
                    [editable]="false"
                    [resultTemplate]="assigneeTmp"
                    [className]="
                      !isValid('devSupport')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('devSupport')"
                  >
                    {{ getValidationMsg('devSupport') }}
                  </div>
                </div>
              </div>

              <div class="form-group col-md-6">
                <label for="depchampion">Deployment Champion</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="depchampionName"
                    [(ngModel)]="displayLabel.deploymentChampion"
                    placeholder="James"
                    (ngModelChange)="
                      displayValueChanged($event, 'deploymentChampion')
                    "
                    [showHint]="false"
                    [ngbTypeahead]="filterAssignee"
                    [inputFormatter]="formatter"
                    [resultTemplate]="assigneeTmp"
                    [editable]="false"
                    [className]="
                      !isValid('depchampionName')
                        ? 'form-control is-invalid'
                        : 'form-control'
                    "
                  />
                  <!-- validation feedback text -->
                  <div
                    class="form-text invalid-feedback"
                    *ngIf="!isValid('depchampionName')"
                  >
                    {{ getValidationMsg('depchampionName') }}
                  </div>
                </div>
              </div>
            </div>
          </wizard-step>

          <!--Checklist-->
          <wizard-step
            [title]="'5: Checklist'"
            [isValid]="isValidStep('step5')"
            [showNext]="true"
          >
            <br />

            <ng-container *ngIf="checklist && checklist.length > 0">
              <div class="row col-md-12" *ngFor="let check of checklist">
                <div class="form-group col-md-6">
                  <label for="{{ check._id }}"
                    >Due Notification for {{ check.name }}</label
                  >
                  <div class="input-group">
                    <input
                      type="date"
                      class="form-control"
                      formControlName="{{ check._id }}"
                      [(ngModel)]="displayLabel.checklist[check._id].dueDate"
                      [className]="
                        !isValid(check._id)
                          ? 'form-control is-invalid'
                          : 'form-control'
                      "
                    />
                    <div
                      class="form-text invalid-feedback"
                      *ngIf="!isValid(check._id)"
                    >
                      {{ getValidationMsg(check._id) }}
                    </div>
                  </div>
                </div>

                <div class="form-group col-md-6">
                  <label>Assignee for {{ check.name }}</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      formControlName="contactPerson-{{ check._id }}"
                      [(ngModel)]="
                        displayLabel.checklist[check._id].contactPerson
                      "
                      (ngModelChange)="valueChanged($event, check._id)"
                      [showHint]="false"
                      [ngbTypeahead]="filterAssignee"
                      [inputFormatter]="formatter"
                      [resultTemplate]="assigneeTmp"
                      [editable]="false"
                      [className]="
                        !isValid('contactPerson-' + check._id)
                          ? 'form-control is-invalid'
                          : 'form-control'
                      "
                    />
                    <div
                      class="form-text invalid-feedback"
                      *ngIf="!isValid('contactPerson-' + check._id)"
                    >
                      {{ getValidationMsg('contactPerson-' + check._id) }}
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </wizard-step>

          <!-- Summary -->
          <wizard-step
            [title]="'Summary'"
            [showNext]="false"
            [isValid]="isValidStep('done')"
            (onComplete)="onSubmit()"
          >
            <div [ngSwitch]="isCompleted">
              <div *ngSwitchDefault>
                <br />
                <div>
                  <span class="font-weight-bold">Release Name: </span
                  ><span
                    [className]="!isValid('name') ? 'text-light bg-danger' : ''"
                    >{{ release.name }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Release Type: </span
                  ><span
                    [className]="
                      !isValid('releaseType') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.releaseType }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Description: </span
                  ><span
                    [className]="
                      !isValid('description') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.description }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Release Date: </span
                  ><span
                    [className]="
                      !isValid('releaseDate') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.releaseDate }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">CAB Date: </span
                  ><span
                    [className]="
                      !isValid('cabDate') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.cabDate }}</span
                  >
                </div>
                <hr />
                <div>
                  <span class="font-weight-bold">Dev/Test Start Date: </span
                  ><span
                    [className]="
                      !isValid('startDate') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.startDate }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Dev/Test Finish Date: </span
                  ><span
                    [className]="
                      !isValid('devFinishDate') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.devFinishDate }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold"
                    >Potential Code Refresh Date: </span
                  ><span
                    [className]="
                      !isValid('refreshDate') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.refreshDate }}</span
                  >
                </div>
                <hr />
                <div>
                  <span class="font-weight-bold">Regression Deploy Date: </span
                  ><span
                    [className]="
                      !isValid('regressionDeployDate')
                        ? 'text-light bg-danger'
                        : ''
                    "
                    >{{ release.regressionDeployDate }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Regression Start Date: </span
                  ><span
                    [className]="
                      !isValid('regressionStartDate')
                        ? 'text-light bg-danger'
                        : ''
                    "
                    >{{ release.regressionStartDate }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Regression End Date: </span
                  ><span
                    [className]="
                      !isValid('regressionEndDate')
                        ? 'text-light bg-danger'
                        : ''
                    "
                    >{{ release.regressionEndDate }}</span
                  >
                </div>
                <hr />
                <div>
                  <span class="font-weight-bold">Test Environment: </span
                  ><span
                    [className]="
                      !isValid('testEnvironment') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.testEnvironment }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Regression Environment: </span
                  ><span
                    [className]="
                      !isValid('regEnvironment') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.regEnvironment }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Site Core: </span
                  ><span
                    [className]="
                      !isValid('sitecore') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.sitecore }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Biz Talk: </span
                  ><span
                    [className]="
                      !isValid('biztalk') ? 'text-light bg-danger' : ''
                    "
                    >{{ release.biztalk }}</span
                  >
                </div>
                <div>
                  <span class="font-weight-bold">Dev Support: </span
                  ><span
                    [className]="
                      !isValid('devSupport') ? 'text-light bg-danger' : ''
                    "
                    >{{ displayLabel.devSupport }}</span
                  >
                </div>

                <div>
                  <span class="font-weight-bold">Deployment Champion: </span
                  ><span
                    [className]="
                      !isValid('depchampionName') ? 'text-light bg-danger' : ''
                    "
                    >{{ displayLabel.deploymentChampion }}</span
                  >
                </div>

                <hr />

                <ng-container *ngIf="checklist && checklist.length > 0">
                  <div *ngFor="let check of checklist">
                    <span class="font-weight-bold"
                      >Due Notification for {{ check.name }}:
                    </span>
                    <span
                      [className]="
                        !isValid(check._id) ? 'text-light bg-danger' : ''
                      "
                      >{{ displayLabel.checklist[check._id].dueDate }}</span
                    >

                    <br />
                    <span class="font-weight-bold"
                      >Assignee for {{ check.name }}:
                    </span>
                    <span
                      [className]="
                        !isValid('contactPerson' + check._id)
                          ? 'text-light bg-danger'
                          : ''
                      "
                      >{{
                        displayLabel.checklist[check._id].contactPerson
                      }}</span
                    >

                    <!-- <ng-container 
                    [ngTemplateOutlet]="assigneeTmp"
                    [ngTemplateOutletContext]="{result: checklist_data[check._id].contactPerson, term:''}">
                  </ng-container>-->
                  </div>
                </ng-container>

                <hr />
              </div>
              <div *ngSwitchCase="true">
                <br />
                <h4>The form has been submitted...</h4>
                <div class="alert alert-warning" *ngIf="!error">
                  Waiting for server response
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div>
              </div>
            </div>
          </wizard-step>
        </form-wizard>
      </form>
    </div>
  </div>
</div>

<!-- Template is used for assignee autocomplete form -->
<ng-template #assigneeTmp let-r="result" let-t="term">
  <span *ngIf="r !== undefined">
    <img [src]="r['avatarUrls']['16x16']" class="mr-1" style="width: 16px" />
    <ngb-highlight [result]="r['displayName']" [term]="t"></ngb-highlight>
  </span>
</ng-template>
